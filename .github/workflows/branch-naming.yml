name: Branch Naming Convention

permissions:
  contents: read

on:
  push:
    branches-ignore:
      - main
      - master
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "Checking branch name: $BRANCH_NAME"
          
          # Check if branch name matches the pattern: (feature|copilot)/<number>-<2-4-words>
          if [[ ! "$BRANCH_NAME" =~ ^(feature|copilot)/[0-9]+-[a-z]+(-[a-z]+){1,3}$ ]]; then
            echo "::error::Branch name '$BRANCH_NAME' does not follow the required convention."
            echo ""
            echo "Required format: feature/<issue-number>-<short-description>"
            echo "              or copilot/<issue-number>-<short-description>"
            echo ""
            echo "Rules:"
            echo "  - Use 'feature/' or 'copilot/' prefix"
            echo "  - Include the issue number after the prefix"
            echo "  - Add a hyphen followed by a short description"
            echo "  - Short description must be:"
            echo "    * lowercase"
            echo "    * hyphen-separated"
            echo "    * 2-4 words only"
            echo ""
            echo "Examples:"
            echo "  ✓ feature/1-init-vite-ts"
            echo "  ✓ feature/48-game-loop-canvas"
            echo "  ✓ copilot/50-emoji-mask"
            echo "  ✓ copilot/60-setup-instructions"
            echo "  ✗ feature/init-app (missing issue number)"
            echo "  ✗ feature/1-Init-App (not lowercase)"
            echo "  ✗ feature/1-this-is-too-many-words (too many words)"
            echo ""
            echo "See /.github/copilot-instructions.md for details."
            exit 1
          fi
          
          # Extract and validate the short description part
          DESC=$(echo "$BRANCH_NAME" | sed 's/^\(feature\|copilot\)\/[0-9]\+-//')
          WORD_COUNT=$(echo "$DESC" | tr '-' '\n' | wc -l)
          
          if [ "$WORD_COUNT" -lt 2 ] || [ "$WORD_COUNT" -gt 4 ]; then
            echo "::error::Branch description '$DESC' must have 2-4 words, found $WORD_COUNT"
            echo "See /.github/copilot-instructions.md for details."
            exit 1
          fi
          
          echo "✓ Branch name is valid!"
